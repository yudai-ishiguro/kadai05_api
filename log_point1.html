<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ­ã‚°ãƒ–ãƒƒã‚¯</title>
    <!-- <style>.remove:hover{background:aquamarine;}</style> -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç”»é¢ -->
    <div>
        <h1>Point1 åº§é–“å‘³ç¯å°ä¸‹</h1>
        <div id="output"></div>
        <h2>ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã™ã‚‹</h2>
        <div>
            æ—¥ä»˜ï¼š<input type="text" id="uname" placeholder="YYYY.MM.DD">
        </div>
        <div>
            <textarea id="text" cols="30" rows="10" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆ"></textarea>
            <button id="send">é€ä¿¡</button>
        </div>
     </div>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script type="module">
// Import the functions you need from the SDKs you need
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js";
import { getDatabase, ref, push, set, update, remove, onChildAdded, onChildChanged, onChildRemoved } 
from "https://www.gstatic.com/firebasejs/10.12.1/firebase-database.js";
// Your web app's Firebase configuration
const firebaseConfig = {
    apiKey: "",
    authDomain: "",
    databaseURL: "",
    projectId: "",
    storageBucket: "",
    messagingSenderId: "",
    appId: ""
};
const app = initializeApp(firebaseConfig);
const db  = getDatabase(app); //RealtimeDBã«æ¥ç¶š
const dbRef = ref(db,"point1"); //RealtimeDBå†…ã®"point1"ã‚’ä½¿ã†

// Google Apps Scriptã®URLã‚’è¿½åŠ ï¼ˆ5.26AM8:30ï¼‰
const scriptUrl = 'https://script.google.com/macros/s/AKfycbwcXXRPF_kxFb5Jpp6mLeDVDbVZeIRLSpJVKs7k2k61X119D_yJ97hYJAAXHVLlnKd6kw/exec';

//ãƒ‡ãƒ¼ã‚¿ç™»éŒ²(Click)
$("#send").on("click",function() {
    const msg = {
        uname: $("#uname").val(),
        text: $("#text").val()
    }
    const newPostRef = push(dbRef); //ãƒ¦ãƒ‹ãƒ¼ã‚¯KEYã‚’ç”Ÿæˆ
    set(newPostRef, msg);           //"chat"ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯KEYã‚’ã¤ã‘ã¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²
    $("#text").val("");
});


// ã‚¨ãƒ³ã‚¿ãƒ¼å…¥åŠ›ã‚’ç„¡åŠ¹åŒ–ï¼ˆ5.26AM8:30ï¼‰
//ãƒ‡ãƒ¼ã‚¿ç™»éŒ²(Enter)
// $("#text").on("keydown",function(e){
//     console.log(e);        //eå¤‰æ•°ã®ä¸­èº«ã‚’ç¢ºèªï¼ï¼
//     if(e.keyCode == 13){   //EnterKey=13
//         const msg = {
//             uname: $("#uname").val(),
//             text: $("#text").val()
//         }
//         const newPostRef = push(dbRef); //ãƒ¦ãƒ‹ãƒ¼ã‚¯KEYã‚’ç”Ÿæˆ
//         set(newPostRef, msg);           //"chat"ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯KEYã‚’ã¤ã‘ã¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²
//     }
// });

//æœ€åˆã«ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼†onSnapshotã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
onChildAdded(dbRef, function(data){   
    const msg  = data.val();    //ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€å¤‰æ•°msgã«ä»£å…¥
    const key  = data.key;      //ãƒ‡ãƒ¼ã‚¿ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼ï¼ˆå‰Šé™¤ã‚„æ›´æ–°ã«ä½¿ç”¨å¯èƒ½ï¼‰

// ç¿»è¨³ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é€ä¿¡ã‚’è¿½åŠ ï¼ˆ5.26AM8:30ï¼‰
    $.ajax({
        url: scriptUrl,
        type: 'GET',
        data: {
            text: msg.text,
            // source: "en", // ç¿»è¨³å…ƒã®è¨€èªã‚³ãƒ¼ãƒ‰ã‚’æŒ‡å®šï¼ˆä¾‹: è‹±èªï¼‰
            target: "en"  // ç¿»è¨³å…ˆã®è¨€èªã‚³ãƒ¼ãƒ‰ã‚’æŒ‡å®šï¼ˆä¾‹: æ—¥æœ¬èªï¼‰
        },
        success: function(response) {
            // ç¿»è¨³ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’è¡¨ç¤º
            let translatedText = response.text;
            let html = '<div class="msg"><p id="'+key+'">';
            html += msg.uname + '<br>';
            html += '<span contentEditable="true" id="'+key+'_update">' +msg.text+'</span>';
            html += '<span class="remove" data-key="'+key+'">ğŸš®</span>'
            html += '<span class="update" data-key="'+key+'">ğŸ†™</span>' + '<br>';
            html += "ã€Œ" 
            html += '<span contentEditable="true" id="'+key+'_translate">' +translatedText+ '</span>';
            html +=  "ã€";
            html += '</p></div>';
            $("#output").prepend(html);
        },
        error: function() {
            console.error("ç¿»è¨³ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }
    });
});
// ä¸‹è¨˜ã¯ã‚ªãƒªã‚¸ãƒŠãƒ«éƒ¨åˆ†ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
    // //è¡¨ç¤ºç”¨ãƒ†ã‚­ã‚¹ãƒˆãƒ»HTMLã‚’ä½œæˆ
    // let h = '<p>';
    //     h += msg.uname;
    //     h += '<br>';
    //     h += msg.text;
    //     h += '</p>';
    //     $("#output").append(h); //#outputã®æœ€å¾Œã«è¿½åŠ 
// });

// å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚ªãƒªã‚¸ãƒŠãƒ«ï¼‰
// $("#output").on("click", ".remove", function(){
//     const key = $(this).attr("data-key");
//     const remove_item = ref(db, "chat/"+key);

//     remove(remove_item);
//     location.reload();// ã‚ã¨ã‹ã‚‰è¿½åŠ ã—ãŸ
// });

// å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºã™ï¼‰
$("#output").on("click", ".remove", function(){
    const key = $(this).attr("data-key");
    const update_item = ref(db, "chat/"+key);
    update(update_item,{
        text: "Deleted Message"
    }).then(() => {
        location.reload();
    }).catch((error) => {
        console.error("Error updating message: ",error);
    });
});



// æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ
$("#output").on("click", ".update", function(){
    const key = $(this).attr("data-key");
    update(ref(db, "chat/"+key),{
        text: $("#"+key+'_update').html()
    });
})

onChildRemoved(dbRef, (data) =>{
$("#"+data.key).remove();
});

onChildChanged(dbRef, (data) =>{
    const updatedText = data.val().text;

// ç¿»è¨³ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¦æ›´æ–°ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
    $.ajax({
        url: scriptUrl,
        type: 'GET',
        data: {
            text: updatedText,
            // source: "en", // ç¿»è¨³å…ƒã®è¨€èªã‚³ãƒ¼ãƒ‰ã‚’æŒ‡å®šï¼ˆä¾‹: è‹±èªï¼‰
            target: "ja"  // ç¿»è¨³å…ˆã®è¨€èªã‚³ãƒ¼ãƒ‰ã‚’æŒ‡å®šï¼ˆä¾‹: æ—¥æœ¬èªï¼‰
        },
    success: function(response) {
        let translatedText = response.text;
        // æ›´æ–°ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’è¡¨ç¤º    
        $("#"+data.key+'_update').html(updatedText);
        $("#"+data.key+'_translate').html(translatedText);
        $("#"+data.key+'_update').fadeOut(800).fadeIn(800);
        $("#"+data.key+'_translate').fadeOut(800).fadeIn(800);  
        },
    error: function() {
        console.error("ç¿»è¨³ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
  });
});

</script>
</body>
</html>